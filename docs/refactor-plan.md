1. Architecture Snapshot
- Repo map: root `apps/web` (TanStack React Start + Vite), `apps/server` (PartyServer on Cloudflare Durable Objects), `docs` (performance notes), root config `package.json`, `tsconfig.base.json`.
- Runtime entrypoints: server `apps/server/src/server.ts` (Worker `fetch` + Durable Object `Room`), server config `apps/server/wrangler.jsonc`, `apps/server/partykit.json`; web entry `@tanstack/react-start/server-entry` in `apps/web/wrangler.jsonc`, routes in `apps/web/src/routes/__root.tsx`, `apps/web/src/routes/index.tsx`, `apps/web/src/routes/game.$sessionId.tsx`, router in `apps/web/src/router.tsx`.
- Major modules/services: server domain logic in `apps/server/src/domain/*` (intents, hidden state, overlay, permissions); client state in `apps/web/src/store/**`; multiplayer sync in `apps/web/src/hooks/game/multiplayer-sync/**`; Yjs doc management in `apps/web/src/yjs/**`; Scryfall integration in `apps/web/src/services/scryfall/**`.
- Data flow (text diagram): Web UI → Zustand store → intent dispatch → intent WS (`apps/web/src/partykit/intentTransport.ts`) → Server `Room` → `applyIntentToDoc` → Yjs public doc + hidden state → overlay build/diff → intent WS → client applies private overlay; in parallel Yjs sync provider (`apps/web/src/hooks/game/multiplayer-sync/sessionResources.ts`) ↔ PartyServer/Yjs doc ↔ client Yjs maps; deck import uses Scryfall HTTPS (`apps/web/src/services/scryfall/cache/scryfallApi.ts`).
- Critical paths: connect/auth/token issuance (`Room.bindIntentConnection`/`bindSyncConnection`), intent handling + ack (`Room.handleIntent` + `applyIntentToDoc`), overlay build/diff + send (`Room.broadcastOverlays`/`sendOverlayForConnectionWithBuildResult`), hidden-state persistence (`Room.persistHiddenState`), Scryfall deck import fetch.
- Top invariants (must always be true): spectators cannot send intents; tokens required once a room is initialized; hidden-zone card data never enters public Yjs maps; overlay versions are monotonic per connection and diffs apply only to the last known version; card positions are normalized [0,1]; hidden state and public snapshot stay consistent.

2. Findings (Evidence-Backed)
- ID: F-001; Title: Monolithic Room lifecycle in `apps/server/src/server.ts`; Why it matters: a single 2,320-line class mixes auth, persistence, overlay diffing, metrics, and connection lifecycle, making regressions likely and testing hard; Evidence: `apps/server/src/server.ts` `Room` class contains auth (`bindIntentConnection`/`bindSyncConnection`), persistence (`persistHiddenState`), overlay logic (`broadcastOverlays`), perf metrics; file length `2320`; Impact: reliability/maintainability; Severity/Confidence/Blast radius: Medium/High/Service-wide; Fix type: Mechanical refactor; Suggested direction: split into focused modules (auth, persistence, overlay, metrics) with a thin coordinator; Quick win? no.
- ID: F-002; Title: Intent application is a 1,311-line switch with mixed concerns; Why it matters: adding/modifying intents risks unintended side effects across hidden/public state and logging; Evidence: `apps/server/src/domain/intents/applyIntentToDoc.ts` (`1311` lines) mixes validation, permissions, hidden state mutation, Yjs writes, and log emission; Impact: correctness/maintainability; Severity/Confidence/Blast radius: Medium/High/Service-wide; Fix type: Mechanical refactor; Suggested direction: extract intent handlers by domain with shared validation helpers and an explicit registry; Quick win? no.
- ID: F-003; Title: Permission/zone/position logic duplicated across client and server; Why it matters: rule drift can cause client-allowed actions to be server-rejected (or vice‑versa); Evidence: `apps/server/src/domain/permissions.ts` vs `apps/web/src/rules/permissions.ts`, `apps/server/src/domain/constants.ts` vs `apps/web/src/constants/zones.ts`, `apps/server/src/domain/positions.ts` vs `apps/web/src/lib/positions.ts`, plus many `apps/server/src/**` imports from `apps/web/src/types/*`; Impact: correctness/maintainability; Severity/Confidence/Blast radius: High/High/Service-wide; Fix type: Mechanical refactor; Suggested direction: move shared rules/types/constants into a shared package and update both apps to consume it; Quick win? yes (start with parity tests + shared fixtures).
- ID: F-004; Title: Auth/token validation duplicated for intent vs sync connections; Why it matters: small divergences in role/token handling can create security or join-flow inconsistencies; Evidence: `apps/server/src/server.ts` `bindIntentConnection` and `bindSyncConnection` both implement token resolution and role decisions with separate logic; Impact: reliability/security/maintainability; Severity/Confidence/Blast radius: Medium/Medium/Service-wide; Fix type: Mechanical refactor; Suggested direction: extract a shared auth resolver returning `{role, token, playerId}` and reuse in both paths; Quick win? yes.
- ID: F-005; Title: Hidden-state persistence is multi-step with silent failure paths; Why it matters: partial writes or swallowed errors can produce incomplete snapshots or stale intent logs after a restart; Evidence: `apps/server/src/server.ts` `persistHiddenState` writes `Y_DOC_STORAGE_KEY`, hidden chunks (`SNAPSHOT_HIDDEN_PREFIX`), and `SNAPSHOT_META_KEY` with multiple `catch {}` blocks (e.g., `ensureIntentLogMeta` ignores `ctx.storage.put` errors) and no transactional commit; Impact: reliability/data integrity; Severity/Confidence/Blast radius: High/Medium/Service-wide; Fix type: Mechanical refactor; Suggested direction: introduce a snapshot writer with explicit “pending/committed” metadata and structured error logging; Quick win? no.
- ID: F-006; Title: Multiplayer connection lifecycle logic is complex and stateful; Why it matters: reconnection/backoff/pause handling is hard to reason about and can regress; Evidence: `apps/web/src/hooks/game/multiplayer-sync/useMultiplayerSync.ts` (~393 lines) maintains many refs/timers and handles backoff, pause, and teardown; Impact: reliability/maintainability; Severity/Confidence/Blast radius: Medium/Medium/Service-wide; Fix type: Mechanical refactor; Suggested direction: extract a pure state machine + timer scheduler with unit tests; Quick win? no.
- ID: F-007; Title: Scryfall fetch failures are silent; Why it matters: deck import can fail without user-visible feedback or telemetry; Evidence: `apps/web/src/services/scryfall/cache/scryfallApi.ts` swallows errors in both `fetchCardById` and `fetchCardCollection`; Impact: reliability/UX; Severity/Confidence/Blast radius: Low/High/Local; Fix type: Mechanical refactor; Suggested direction: return structured errors and surface warnings in UI/logs; Quick win? yes.

3. Refactor Strategy
- Guiding principles for this codebase: preserve external behavior; extract seams before moving logic; keep server‑authoritative rules in one place; add characterization tests before refactors on intent/persistence paths.
- Sequencing logic (why this order): lock down correctness-critical rules (shared permissions/zones) first, then de-risk Room persistence/auth, then modularize intent handlers, then simplify client connection lifecycle.
- Non-goals (what you explicitly won’t touch): no UI redesign, no change to Yjs/PartyServer transport, no protocol changes, no gameplay rule changes.

4. Trackable Refactor Plan (Epics → Tasks)

Status legend: `not-started` | `in-progress` | `blocked` | `done`

- Epic ID: E-01; Status: done; Outcome metric(s): `rg "web/src" apps/server/src` returns 0 (production code), single source of truth for zones/permissions/positions, parity tests pass.
- T-001 Title: Create shared rules/types package; Status: done; Scope: new `packages/shared` (types, zones, permissions, positions), update root `package.json` workspaces and TS configs; Steps: add package scaffolding, move/copy shared modules, export stable API, keep existing modules re-exporting for a transition period; Acceptance criteria: both apps compile against shared package, no runtime behavior change; Verification: `bun run typecheck`, `bun run test`; Risk/rollback: module resolution issues—rollback by reverting imports; Dependencies: none; Owner skills required: TS module/package setup; Estimated effort: M.
- T-002 Title: Migrate server imports to shared contract; Status: done; Scope: `apps/server/src/domain/*`, `apps/server/src/server.ts`; Steps: replace `../../../web/src/*` imports with shared package, update constants/permissions/positions references; Acceptance criteria: server tests pass, no direct web imports in server code; Verification: `rg "web/src" apps/server/src`, `bun run --cwd apps/server test`; Risk/rollback: import path regressions—rollback to prior imports; Dependencies: T-001; Owner skills required: TS refactoring; Estimated effort: S.
- T-003 Title: Migrate web rules/constants to shared contract; Status: done; Scope: `apps/web/src/rules/permissions.ts`, `apps/web/src/constants/zones.ts`, `apps/web/src/lib/positions.ts`; Steps: re-export from shared, remove duplicates once parity tests pass; Acceptance criteria: web tests pass and UI behavior unchanged; Verification: `bun run --cwd apps/web test`, manual smoke of create/join; Risk/rollback: UI behavior drift—rollback to local modules; Dependencies: T-001; Owner skills required: TS refactoring; Estimated effort: M.

- Epic ID: E-02; Status: done; Outcome metric(s): `apps/server/src/server.ts` reduced by ≥30%, snapshot failures logged with context, no perf regression in overlay bench.
- T-010 Title: Extract connection auth/role resolution; Status: done; Scope: `apps/server/src/server.ts`, new `apps/server/src/connection/auth.ts`; Steps: factor token parsing + role resolution into pure helpers; reuse in `bindIntentConnection` and `bindSyncConnection`; Acceptance criteria: identical auth decisions for existing fixtures; Verification: server tests + new auth unit tests; Risk/rollback: subtle auth regressions—rollback to inline logic; Dependencies: none; Owner skills required: TS refactor; Estimated effort: S.
- T-011 Title: Extract overlay diff/build service; Status: done; Scope: `apps/server/src/server.ts`, new `apps/server/src/overlay/*`; Steps: move hash/diff/snapshot payload builders and overlay state caching into a service class; Acceptance criteria: overlay payloads unchanged for same inputs; Verification: `apps/server/scripts/overlay-bench.ts` and `apps/server/src/__tests__/overlayVisibility.behavior.test.ts`; Risk/rollback: diff mismatch—rollback to old methods; Dependencies: none; Owner skills required: TS refactor; Estimated effort: M.
- T-012 Title: Introduce snapshot writer with commit semantics; Status: done; Scope: `apps/server/src/server.ts`, new `apps/server/src/storage/snapshotStore.ts`; Steps: write snapshot in “pending” state, commit meta last, add explicit cleanup on failure, log errors with room/conn; Acceptance criteria: restore uses committed snapshots only, no orphaned meta after failure; Verification: add unit tests for partial write handling + `apps/server/src/__tests__/hiddenStateChunking.test.ts`; Risk/rollback: storage compatibility—guard with env flag (e.g., `SNAPSHOT_STORE_V2`); Dependencies: none; Owner skills required: DO storage + testing; Estimated effort: M.

- Epic ID: E-03; Status: done; Outcome metric(s): `applyIntentToDoc.ts` < 500 lines, intent handlers have focused tests.
- T-020 Title: Create intent handler registry; Status: done; Scope: `apps/server/src/domain/intents/*`; Steps: split intent switch into modules (`player`, `card`, `deck`, `zone`, `misc`), each returning `InnerApplyResult`; Acceptance criteria: existing intent tests pass unchanged; Verification: `bun run --cwd apps/server test` + `apps/server/scripts/intent-bench.ts`; Risk/rollback: handler wiring errors—rollback by keeping old switch; Dependencies: none; Owner skills required: TS refactor; Estimated effort: M.
- T-021 Title: Extract shared validation helpers; Status: done; Scope: `apps/server/src/domain/intents/validation.ts`, update handlers to use it; Steps: centralize payload parsing/guards and permission checks; Acceptance criteria: consistent error strings across intents; Verification: existing tests + new validation unit tests; Risk/rollback: error message drift—keep compatibility assertions; Dependencies: T-020; Owner skills required: TS refactor; Estimated effort: S.

- Epic ID: E-04; Status: done; Outcome metric(s): deterministic connection state transitions with unit tests; reduced `useMultiplayerSync.ts` complexity.
- T-030 Title: Extract connection lifecycle state machine; Status: done; Scope: new `apps/web/src/hooks/game/multiplayer-sync/connectionMachine.ts`, refactor `apps/web/src/hooks/game/multiplayer-sync/useMultiplayerSync.ts`; Steps: model states/events, move timer/backoff logic into machine, keep hook as adapter; Acceptance criteria: hook behavior unchanged under existing tests; Verification: add unit tests for machine + `bun run --cwd apps/web test`; Risk/rollback: reconnect regressions—keep old hook behind feature flag; Dependencies: none; Owner skills required: React + state machines; Estimated effort: M.
- T-031 Title: Add reconnect/teardown diagnostics; Status: done; Scope: `apps/web/src/logging/*`, `apps/web/src/hooks/game/multiplayer-sync/useMultiplayerSync.ts`; Steps: emit structured log entries for reconnect reasons and auth failures; Acceptance criteria: log events visible in log drawer and no runtime errors; Verification: component tests + manual reconnection test; Risk/rollback: noisy logs—feature flag in client prefs; Dependencies: T-030; Owner skills required: React + logging; Estimated effort: S.

- Epic ID: E-05; Status: done; Outcome metric(s): visible, actionable deck import errors; fewer silent failures.
- T-040 Title: Return structured errors from Scryfall fetches; Status: done; Scope: `apps/web/src/services/scryfall/cache/scryfallApi.ts`, `apps/web/src/services/deck-import/*`; Steps: replace `null` returns with `Result`-style error objects, plumb to deck import flow; Acceptance criteria: UI shows a clear error when cards cannot be fetched; Verification: `apps/web/src/services/deck-import/__tests__/deckImport.unit.test.ts`; Risk/rollback: UI regressions—fallback to old return shape; Dependencies: none; Owner skills required: TS + React; Estimated effort: S.

5. Test & Safety Plan
- Baseline test coverage snapshot (if possible): Vitest tests in `apps/server/src/**/__tests__` and `apps/web/src/**/__tests__`; web uses `apps/web/src/test/setup.ts` and `apps/web/vitest.config.ts`; no coverage reporting configured.
- Where to add tests first (and why): permission/zone/position parity tests (correctness), snapshot writer tests (data integrity), intent handler unit tests (behavior lock-in), connection machine tests (reliability).
- Golden tests / characterization tests for risky areas: session lifecycle + replay (`apps/server/src/__tests__/sessionLifecycle.behavior.test.ts`), overlay diff apply (`apps/web/src/store/__tests__/privateOverlay.behavior.test.ts`), shared fixtures for permission parity.
- Rollout plan (feature flags, canaries, metrics): guard snapshot writer and connection machine behind env/client flags, validate in dev/staging first, monitor `[perf] room metrics` logs and error counts, rollback via flags.

6. “First 3 PRs” Proposal
- PR#1: Add characterization tests that lock rule parity and overlay invariants; Files: new parity fixtures + tests (e.g., `apps/server/src/domain/__tests__/permissions.parity.test.ts`, `apps/web/src/rules/__tests__/permissions.parity.test.ts`); Checks: `bun run test`; Success metrics: parity tests pass and prevent drift.
- PR#2: Mechanical refactor of auth/token resolution; Files: new `apps/server/src/connection/auth.ts`, edits to `apps/server/src/server.ts` `bindIntentConnection`/`bindSyncConnection`; Checks: `bun run --cwd apps/server test`; Success metrics: no behavior change, identical auth outcomes in unit tests.
- PR#3: First architecture improvement—introduce shared contract package; Files: `packages/shared/*`, updates to root `package.json` workspaces, server imports updated to shared; Checks: `bun run typecheck` + server tests; Success metrics: no `apps/server/src` imports from `apps/web/src`, server builds with shared types/constants.
